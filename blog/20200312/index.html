<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png"><link rel="icon" type="image/png" href="/img/favicon.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="description" content=""><meta name="author" content="Regnover"><meta name="keywords" content=""><title>前端面试 09=02.js运行机制：异步和单线程 ~ Regnover</title><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/5.10.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.3.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/mdbootstrap/4.8.7/css/mdb.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/3.0.1/github-markdown.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1067060_qzomjdt8bmp.css"><link rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="/css/main.css"><script src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js"></script><style type="text/css">.banner-bg{background-image:url(https://s2.ax1x.com/2020/02/12/1H1EfP.png);background-position:center;background-repeat:repeat-y;background-size:cover;background-attachment:fixed}</style><meta name="generator" content="Hexo 4.2.0"></head><body class="banner-bg"><header style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/">&nbsp;<strong>Regnover</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/">首页</a></li><li class="nav-item"><a class="nav-link" href="/archives/">归档</a></li><li class="nav-item"><a class="nav-link" href="/categories/">分类</a></li><li class="nav-item"><a class="nav-link" href="/tags/">标签</a></li><li class="nav-item"><a class="nav-link" href="/about/">关于</a></li><li class="nav-item" id="search-btn"><a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i class="iconfont icon-search"></i>&nbsp;&nbsp;</a></li></ul></div></div></nav><div class="view intro-2 rgba-black-slight" id="background"><div class="full-bg-img"><div class="mask flex-center"><div class="container text-center white-text fadeInUp"><span class="h2" id="subtitle"></span><br><p class="mt-3"><i class="far fa-calendar-alt"></i> <span class="post-date">2020-03-12&nbsp;|&nbsp;</span> <i class="far fa-chart-bar"></i> <span class="post-count">1.6k</span>字&nbsp;|&nbsp; <i class="far fa-clock"></i> <span class="post-count">6</span>分钟 <span id="busuanzi_container_page_pv" style="display:none">&nbsp;|&nbsp; <i class="far fa-eye"></i> <span id="busuanzi_value_page_pv"></span>次</span></p></div></div></div></div></header><main id="mainContent" class="rgba-black-slight"><div class="container-fluid"><div class="row"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-md"><div class="py-5 z-depth-3" id="board"><div class="post-content mx-auto" id="post"><div class="markdown-body"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>面试时，关于<code>同步和异步</code>，可能会问以下问题：</p><ul><li><p>同步和异步的区别是什么？分别举一个同步和异步的例子</p></li><li><p>一个关于 setTimeout 的笔试题</p></li><li><p>前端使用异步的场景哪些？</p></li></ul><p>面试时，关于<code>js运行机制</code>，需要注意以下几个问题：</p><ul><li><p>如何理解JS的<strong>单线程</strong></p></li><li><p>什么是<strong>任务队列</strong></p></li><li><p>什么是 EventLoop</p></li><li><p>理解哪些语句会放入异步任务队列</p></li><li><p>理解语句放入异步任务队列的<strong>时机</strong></p></li></ul><h2 id="JS的异步和单线程"><a href="#JS的异步和单线程" class="headerlink" title="JS的异步和单线程"></a>JS的异步和单线程</h2><blockquote><p>因为是单线程，所以必须异步。</p></blockquote><p>我们通过题目来解释以下。</p><h3 id="题目一：异步"><a href="#题目一：异步" class="headerlink" title="题目一：异步"></a>题目一：异步</h3><p>现有如下代码：</p><pre><code class="javascript">    console.log(1);
    setTimeout(function () {
        console.log(2);
    }, 1000);
    console.log(3);
    console.log(4);
</code></pre><p>上面的代码中，我们很容易知道，打印的顺序是<code>1，3，4，2</code>。因为你会想到，要等一秒之后再打印<code>2</code>。</p><p>可如果我把延时的时间从<code>1000</code>改成<code>0</code>：</p><pre><code class="javascript">    console.log(1);
    setTimeout(function () {
        console.log(2);
    }, 0);
    console.log(3);
    console.log(4);</code></pre><p>上方代码中，打印的顺序仍然是<code>1，3，4，2</code>。这是为什么呢？我们来分析一下。</p><p><strong>总结：</strong></p><p>js 是单线程（同一时间只能做一件事），而且有一个<strong>任务队列</strong>：全部的同步任务执行完毕后，再来执行异步任务。第一行代码和最后一行代码是同步任务；但是，<strong><code>setTimeout</code>是异步任务</strong>。</p><p>于是，执行的顺序是：</p><ul><li><p>先执行同步任务<code>console.log(1)</code></p></li><li><p>遇到异步任务<code>setTimeout</code>，要<strong>挂起</strong></p></li><li><p>执行同步任务<code>console.log(3)</code></p></li><li><p><strong>全部的同步任务执行完毕后，再来执行异步任务</strong><code>console.log(2)</code>。</p></li></ul><p>很多人会把这个题目答错，这是因为他们不懂 js 的运行机制。</p><p>注意上面那句话：同步任务执行完毕后，再来执行异步任务。也就是说，<strong>如果同步任务没有执行完，异步任务是不会执行的</strong>。为了解释这句话，我们来看下面这个例子。</p><h3 id="题目二：异步"><a href="#题目二：异步" class="headerlink" title="题目二：异步"></a>题目二：异步</h3><p>现有如下代码：</p><pre><code class="javascript">    console.log(&#39;A&#39;);
    while (1) {

    }
    console.log(&#39;B&#39;);</code></pre><p>我们很容易想到，上方代码的打印结果是<code>A</code>，因为while是同步任务，代码会陷入死循环里出不来，自然也就无法打印<code>B</code>。可如果我把代码改成下面的样子：</p><pre><code class="javascript">    console.log(&#39;A&#39;);

    setTimeout(function () {
        console.log(&#39;B&#39;);
    })

    while (1) {

    }
</code></pre><p>上方代码的打印结果仍然是<code>A</code>。因为while是同步任务，setTimeout是异步任务，所以还是那句话：<strong>如果同步任务没有执行完，队列里的异步任务是不会执行的</strong>。</p><h3 id="题目三：同步"><a href="#题目三：同步" class="headerlink" title="题目三：同步"></a>题目三：同步</h3><pre><code class="javascript">    console.log(&#39;A&#39;);

    alert(&#39;haha&#39;); //1秒之后点击确认

    console.log(&#39;B&#39;);
</code></pre><p><code>alert</code>函数是同步任务，我只有点击了确认，才会继续打印<code>B</code>。</p><h3 id="同步和异步的对比"><a href="#同步和异步的对比" class="headerlink" title="同步和异步的对比"></a>同步和异步的对比</h3><p>我们在上面列举了异步和同步的例子。现在来描述一下区别：【重要】</p><p>因为<code>setTimeout</code>是<strong>异步任务</strong>，所以程序并不会卡在那里，而是继续向下执行（即使settimeout设置了倒计时一万秒）；但是<code>alert</code>函数是<strong>同步</strong>任务，程序会<strong>卡在那里</strong>，如果它没有执行，后面的也不会执行（卡在那里，自然也就造成了<strong>阻塞</strong>）。</p><h3 id="前端使用异步的场景"><a href="#前端使用异步的场景" class="headerlink" title="前端使用异步的场景"></a>前端使用异步的场景</h3><p>什么时候需要<strong>等待</strong>，就什么时候用异步。</p><ul><li><p>定时任务：setTimeout（定时炸弹）、setInterval（循环执行）</p></li><li><p>网络请求：ajax请求、动态<code>&lt;img&gt;</code>加载</p></li><li><p>事件绑定（比如说，按钮绑定点击事件之后，用户爱点不点。我们不可能卡在按钮那里，什么都不做。所以，应该用异步）</p></li><li><p>ES6中的Promise</p></li></ul><p>代码举例：</p><pre><code class="javascript">    console.log(&#39;start&#39;);
    var img = document.createElement(&#39;img&#39;);
    img.onload = function () {
        console.log(&#39;loaded&#39;);
    }
    img.src = &#39;/xxx.png&#39;;
    console.log(&#39;end&#39;);</code></pre><p>上图中，先打印<code>start</code>，然后执行<code>img.src = &#39;/xxx.png&#39;</code>，然后打印<code>end</code>，最后打印<code>loaded</code>。</p><h2 id="任务队列和Event-Loop（事件循环）"><a href="#任务队列和Event-Loop（事件循环）" class="headerlink" title="任务队列和Event Loop（事件循环）"></a>任务队列和Event Loop（事件循环）</h2><h3 id="任务队列"><a href="#任务队列" class="headerlink" title="任务队列"></a>任务队列</h3><p>所有任务可以分成两种，一种是同步任务（synchronous），另一种是异步任务（asynchronous）。同步任务指的是，在主线程上排队执行的任务，只有前一个任务执行完毕，才能执行后一个任务。异步任务指的是，不进入主线程、而进入”任务队列”（task queue）的任务，只有”任务队列”通知主线程，某个异步任务可以执行了，该任务才会进入主线程执行。</p><p>总结：<strong>只要主线程空了，就会去读取”任务队列”，这就是JavaScript的运行机制</strong>。【重要】</p><h3 id="Event-Loop"><a href="#Event-Loop" class="headerlink" title="Event Loop"></a>Event Loop</h3><p>主线程从”任务队列”中读取事件，这个过程是循环不断的，所以整个的这种运行机制又称为Event Loop（事件循环）。</p><p><img src="http://img.smyhvae.com/20180310_1840.png" srcset="/img/loading.gif" alt=""></p><p>在理解Event Loop时，要理解两句话：</p><ul><li><p>理解哪些语句会放入异步任务队列</p></li><li><p>理解语句放入异步任务队列的<strong>时机</strong></p></li></ul><h3 id="容易答错的题目"><a href="#容易答错的题目" class="headerlink" title="容易答错的题目"></a>容易答错的题目</h3><pre><code class="javascript">    for (var i = 0; i &lt; 3; i++) {
        setTimeout(function () {
            console.log(i);
        }, 1000);
    }</code></pre><p>很多人以为上面的题目，答案是<code>0,1,2,3</code>。其实，正确的答案是：<code>3,3,3,3</code>。</p><p>分析：for 循环是同步任务，setTimeout是异步任务。for循环每次遍历的时候，遇到settimeout，就先暂留着，等同步任务全部执行完毕（此时，i已经等于3了），再执行异步任务。</p><p>我们把上面的题目再加一行代码。最终代码如下：</p><pre><code class="javascript">    for (var i = 0; i &lt; 3; i++) {
        setTimeout(function () {
            console.log(i);
        }, 1000);
    }
    console.log(i);</code></pre><p>如果我们约定，用箭头表示其前后的两次输出之间有 1 秒的时间间隔，而逗号表示其前后的两次输出之间的时间间隔可以忽略，代码实际运行的结果该如何描述？可能会有两种答案：</p><ul><li><p>A. 60% 的人会描述为：<code>3 -&gt; 3 -&gt; 3 -&gt; 3</code>，即每个 3 之间都有 1 秒的时间间隔；</p></li><li><p>B. 40% 的人会描述为：<code>3 -&gt; 3,3,3</code>，即第 1 个 3 直接输出，1 秒之后，连续输出 3 个 3。</p></li></ul><p>循环执行过程中，几乎同时设置了 3 个定时器，这些定时器都会在 1 秒之后触发，而循环完的输出是立即执行的，显而易见，正确的描述是 B。</p><p>上面这个题目的参考链接：</p><ul><li><p><a href="https://juejin.im/post/58cf180b0ce4630057d6727c" target="_blank" rel="noopener">80% 应聘者都不及格的 JS 面试题</a></p></li><li><p><a href="https://zhuanlan.zhihu.com/p/26229293" target="_blank" rel="noopener">深入浅出Javascript事件循环机制(上)</a></p></li></ul><blockquote><p>本文转载自<a href="https://github.com/smyhvae/Web" target="_blank" rel="noopener">GitHub</a></p></blockquote><hr></div><br><div><div id="post-tag"><span><i class="iconfont icon-inbox"></i> <a class="hover-with-bg" href="/categories/%E6%96%87%E6%A1%A3">文档</a> &nbsp; </span><span><i class="iconfont icon-tag"></i> <a class="hover-with-bg" href="/tags/web">web</a> <a class="hover-with-bg" href="/tags/interview">interview</a></span></div><div id="post-note"><div><strong>本文作者：</strong><a href="/">Regnover</a></div><div><strong>本文链接：</strong><a href="http://regnover.xyz/blog/20200312/">http://regnover.xyz/blog/20200312/</a></div><div><strong>版权声明：</strong>本博客所有文章除特别声明外，均采用 <a href="https://zh.wikipedia.org/wiki/Wikipedia:CC_BY-SA_3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" target="_blank" rel="nofollow noopener noopener">CC BY-SA 3.0协议</a> 。转载请注明出处！</div></div><div id="post-nav" class="container"><div class="row"><a href="/blog/20200313/" id="post-nav-prev" class="col"><i class="fas fa-arrow-left"></i> <span class="post-nav-title">前端面试 10-01.页面性能优化</span> </a><a href="/blog/20200311/" id="post-nav-next" class="col"><span class="post-nav-title">前端面试 09-01.浏览器渲染机制</span> <i class="fas fa-arrow-right"></i></a></div></div></div></div><div class="col-lg-10 mx-auto nopadding-md"><div class="container comments mx-auto" id="comments"></div></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container"><div id="toc"><p class="h4"><i class="far fa-list-alt"></i>&nbsp;目录</p><div id="tocbot"></div></div></div></div></div></main><div id="sidebar" class="sidebar-hide"><span class="sidebar-button sidebar-button-shift" id="toggle-sidebar"><i class="fa fa-arrow-right on" aria-hidden="true"></i></span><div class="sidebar-overlay"></div><div class="sidebar-intrude"><div class="sidebar-avatar"><img src="/img/avatar.jpg" srcset="/img/avatar.jpg" alt="avatar"></div><div class="text-center sidebar-about"><p class="h3 sidebar-author">Regnover</p><p class="sidebar-subtitle"></p><a href="https://github.com/Regnover" class="h4" target="_blank"><i class="fab fa-github" aria-hidden="true"></i> </a>&nbsp;&nbsp; <a href="https://twitter.com" class="h4" target="_blank"><i class="fab fa-twitter" aria-hidden="true"></i> </a>&nbsp;&nbsp; <a href="mailto:example@example.com" class="h4" target="_blank"><i class="fas fa-envelope" aria-hidden="true"></i> </a>&nbsp;&nbsp;</div><div class="sidebar-friend"><p class="h6 sidebar-friend-title"><span class="sidebar-label-left"><i class="fas fa-user-friends"></i></span> <span class="sidebar-label">友情链接</span></p><ul class="list-group"><a href="https://example.com/" target="_blank"><li class="list-group-item"><i class="fas fa-quote-left"></i>&nbsp; friendname</li></a></ul></div></div></div><a class="z-depth-1" id="scroll-top-button" href="#" role="button"><i class="fa fa-chevron-up scroll-top-arrow" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div><div id="footerContent" class="rgba-black-slight"><footer class="pt-5"><div class="text-center py-3"><div class="footer-theme"><a href="https://hexo.io" target="_blank" rel="nofollow noopener noreferrer">Hexo</a> theme <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener noreferrer">Fluid</a> mod by <a href="https://github.com/qixa/hexo-theme-fluid-mod" target="_blank" rel="nofollow noopener noreferrer">Julydate</a></div><div class="footer-copyright">©2020&nbsp;Regnover</div><div class="footer-siteview"><span id="busuanzi_container_site_pv" style="display:none">被瞅了<span id="busuanzi_value_site_pv"></span>次 </span><span id="busuanzi_container_site_uv" style="display:none">| 被<span id="busuanzi_value_site_uv"></span>人看爆</span></div><div class="footer-hitokoto"><a id="hitokotoa" href="#" target="_blank" rel="nofollow noopener noreferrer"><span id="hitokoto"></span></a></div></div></footer></div><script src="/lib/popper/popper.min.js"></script><script src="https://cdn.staticfile.org/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script><script src="https://cdn.staticfile.org/mdbootstrap/4.8.7/js/mdb.min.js"></script><script src="/js/main.js"></script><script src="/js/lazyload.js"></script><script src="https://cdn.staticfile.org/tocbot/4.8.1/tocbot.min.js"></script><script src="/js/post.js"></script><script src="https://cdn.staticfile.org/typed.js/2.0.9/typed.min.js"></script><script type="text/javascript">var typed=new Typed("#subtitle",{strings:["  ","前端面试 09=02.js运行机制：异步和单线程&nbsp;"],cursorChar:"_",typeSpeed:70,loop:!1});typed.stop(),$(document).ready(function(){$(".typed-cursor").addClass("h2"),typed.start()})</script><script src="https://cdn.staticfile.org/anchor-js/4.2.0/anchor.min.js"></script><script type="text/javascript">anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))</script><script src="/js/local-search.js"></script><script type="text/javascript">var path="/local-search.xml",inputArea=document.querySelector("#local-search-input");inputArea.onclick=function(){getSearchFile(path),this.onclick=null}</script><script src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js"></script><script type="text/javascript">var setupFancybox=function(){$("#post img:not(.no-zoom img, img[no-zoom])").each(function(){var t=document.createElement("a");$(t).attr("data-fancybox","gallery"),$(t).attr("href",$(this).attr("src")),$(this).wrap(t)})};setupFancybox()</script><script type="text/javascript">$("img.image_random").each(function(){var n=$(this);$.get("//img.xjh.me/random_img.php?return=json",function(i,m){"success"===m&&200===i.result&&(n[0].src=i.img)})})</script><script type="text/javascript">function hitokoto(t){$("#hitokoto").stop().fadeOut(function(){$("#hitokoto").html(t.hitokoto),document.getElementById("hitokotoa").href="https://hitokoto.cn?id="+t.id,$("#hitokoto").stop().fadeIn()})}function getHitokoto(){var t=["a","b","c","d"],o=document.createElement("script");o.type="text/javascript",o.id="hitokotoko_js",o.src="//v1.hitokoto.cn/?encode=json&callback=hitokoto&charset=utf-8&cat="+t[Math.floor(Math.random()*t.length)],$("#hitokoto").append(o)}$(document).ready(function(){getHitokoto()}),setInterval(getHitokoto,1e4)</script><script async src="//cdn.jsdelivr.net/npm/busuanzi@2.3.0/bsz.pure.mini.js"></script><script type="text/javascript">$("#background").removeClass("banner-bg"),$("body").addClass("banner-bg");var postToTopHight=$("#board").offset().top;$(window).scroll(function(){var o=document.body.scrollTop+document.documentElement.scrollTop;postToTopHight<=o?($("#background").removeClass("rgba-black-slight"),$("#mainContent").removeClass("rgba-black-slight"),$("#footerContent").removeClass("rgba-black-slight")):($("#background").addClass("rgba-black-slight"),$("#mainContent").addClass("rgba-black-slight"),$("#footerContent").addClass("rgba-black-slight"))})</script><script type="text/javascript">var originalTitle=document.title;window.onblur=function(){document.title="网页崩溃了~~"},window.onfocus=function(){document.title=originalTitle}</script><script type="text/javascript">console.log("雪花效果 code by kvv.me"),function(){function n(){r.width=window.innerWidth,r.height=window.innerHeight,c=Math.round(window.innerWidth*window.innerHeight/1e4)}var r=document.createElement("canvas"),d=requestAnimationFrame||msRequestAnimationFrame||function(n){setTimeout(n,16)},h=0,c=0,m=[];n(),r.className="snow",document.body.appendChild(r);for(var i=0;i<c;i++)m.push({x:Math.random()*window.innerWidth,y:Math.random()*window.innerHeight,radius:4*Math.random()+1,direction:2*Math.random()-.5});addEventListener("resize",n),d(function n(){var i=window.innerWidth,e=window.innerHeight,t=r.getContext("2d");t.clearRect(0,0,i,e),t.fillStyle="rgba(255, 255, 255, 0.7)",t.beginPath(),h+=.01;for(var a=0;a<c;a++){var o=m[a];o&&(t.moveTo(o.x,o.y),t.arc(o.x,o.y,o.radius,0,2*Math.PI,!0),o.y+=Math.cos(h)+o.radius/2,o.x+=Math.sin(h*o.direction),(o.x>i+5||o.x<-5||o.y>e)&&(0<a%3?(m[a].x=Math.random()*i,m[a].y=-10):(0<Math.sin(h*o.direction)?m[a].x=-5:m[a].x=i+5,m[a].y=Math.random()*e)))}t.fill(),d(n)})}()</script></body></html>